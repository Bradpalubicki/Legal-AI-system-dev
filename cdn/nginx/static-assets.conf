# =============================================================================
# NGINX Configuration for Static Assets with CDN-Ready Cache Headers
# =============================================================================
#
# This configuration serves static assets with optimal cache headers
# for use with or without a CDN. Can be included in main nginx.conf.
#
# Usage:
#   include /etc/nginx/conf.d/static-assets.conf;
#

# =============================================================================
# GZIP COMPRESSION
# =============================================================================

gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/json
    application/javascript
    application/xml+rss
    application/rss+xml
    application/atom+xml
    image/svg+xml
    application/font-woff
    application/font-woff2
    application/vnd.ms-fontobject
    application/x-font-ttf
    font/opentype;

# =============================================================================
# BROTLI COMPRESSION (if module available)
# =============================================================================

# brotli on;
# brotli_comp_level 6;
# brotli_types
#     text/plain
#     text/css
#     text/xml
#     text/javascript
#     application/json
#     application/javascript
#     application/xml+rss
#     image/svg+xml;

# =============================================================================
# STATIC FILE SERVING
# =============================================================================

# Versioned static assets (long-term caching)
# Files with content hash in filename: app.abc123.js
location ~* ^/static/.*\.[a-f0-9]{8,}\.(css|js|jpg|jpeg|png|gif|svg|woff|woff2|ttf|eot|otf)$ {
    # Cache for 1 year (immutable assets)
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";

    # Security headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;

    # CORS headers for fonts
    add_header Access-Control-Allow-Origin "*";

    # Disable access logs for static files
    access_log off;

    # Enable sendfile for performance
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
}

# Next.js static assets (with build hash)
location ~* ^/_next/static/ {
    # Cache for 1 year (immutable assets)
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Content-Type-Options "nosniff" always;

    access_log off;
    sendfile on;
    tcp_nopush on;
}

# CSS files (versioned)
location ~* \.css$ {
    expires 7d;
    add_header Cache-Control "public, max-age=604800";
    add_header X-Content-Type-Options "nosniff" always;

    access_log off;
    sendfile on;
}

# JavaScript files (versioned)
location ~* \.js$ {
    expires 7d;
    add_header Cache-Control "public, max-age=604800";
    add_header X-Content-Type-Options "nosniff" always;

    access_log off;
    sendfile on;
}

# Images
location ~* \.(jpg|jpeg|png|gif|svg|webp|avif|ico)$ {
    expires 30d;
    add_header Cache-Control "public, max-age=2592000";
    add_header X-Content-Type-Options "nosniff" always;
    add_header Vary "Accept-Encoding";

    access_log off;
    sendfile on;
}

# Fonts (maximum caching)
location ~* \.(woff|woff2|ttf|eot|otf)$ {
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header Access-Control-Allow-Origin "*";
    add_header X-Content-Type-Options "nosniff" always;

    access_log off;
    sendfile on;
}

# Video files
location ~* \.(mp4|webm|ogg|avi|mov)$ {
    expires 30d;
    add_header Cache-Control "public, max-age=2592000";

    # Enable range requests for video streaming
    add_header Accept-Ranges bytes;

    access_log off;
    sendfile on;
}

# PDF and document files
location ~* \.(pdf|doc|docx|xls|xlsx|ppt|pptx)$ {
    expires 7d;
    add_header Cache-Control "public, max-age=604800";
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;

    # Force download for certain file types
    add_header Content-Disposition "attachment";

    access_log off;
    sendfile on;
}

# HTML files (short cache with revalidation)
location ~* \.(html|htm)$ {
    expires 1h;
    add_header Cache-Control "public, max-age=3600, must-revalidate";
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;

    sendfile on;
}

# JSON files
location ~* \.(json)$ {
    expires 1h;
    add_header Cache-Control "public, max-age=3600";
    add_header Content-Type "application/json";
    add_header X-Content-Type-Options "nosniff" always;

    access_log off;
    sendfile on;
}

# XML files
location ~* \.(xml)$ {
    expires 1h;
    add_header Cache-Control "public, max-age=3600";
    add_header X-Content-Type-Options "nosniff" always;

    access_log off;
    sendfile on;
}

# =============================================================================
# SPECIAL ROUTES
# =============================================================================

# Robots.txt and sitemap
location ~* ^/(robots\.txt|sitemap\.xml|sitemap\.xml\.gz)$ {
    expires 1d;
    add_header Cache-Control "public, max-age=86400";
    access_log off;
}

# Favicon
location = /favicon.ico {
    expires 30d;
    add_header Cache-Control "public, max-age=2592000";
    access_log off;
    log_not_found off;
}

# Apple touch icons
location ~* ^/apple-touch-icon.*\.png$ {
    expires 30d;
    add_header Cache-Control "public, max-age=2592000";
    access_log off;
}

# Service worker (must not be cached)
location = /service-worker.js {
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
}

# Manifest file
location = /manifest.json {
    expires 7d;
    add_header Cache-Control "public, max-age=604800";
    add_header Content-Type "application/manifest+json";
}

# =============================================================================
# SECURITY
# =============================================================================

# Deny access to hidden files
location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
}

# Deny access to backup files
location ~* \.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist|old|backup)$ {
    deny all;
    access_log off;
    log_not_found off;
}

# =============================================================================
# PERFORMANCE TUNING
# =============================================================================

# File descriptor caching
open_file_cache max=10000 inactive=30s;
open_file_cache_valid 60s;
open_file_cache_min_uses 2;
open_file_cache_errors on;

# Buffer sizes
client_body_buffer_size 10K;
client_header_buffer_size 1k;
large_client_header_buffers 4 16k;

# Timeouts
client_body_timeout 12;
client_header_timeout 12;
keepalive_timeout 65;
send_timeout 10;

# =============================================================================
# CDN INTEGRATION
# =============================================================================

# Add CDN cache status header (for debugging)
add_header X-Cache-Status $upstream_cache_status always;

# Vary header for proper CDN caching
add_header Vary "Accept-Encoding" always;

# =============================================================================
# CORS FOR STATIC ASSETS (if needed)
# =============================================================================

# Uncomment if serving assets to different domains
# add_header Access-Control-Allow-Origin "https://example.com" always;
# add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
# add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept" always;
