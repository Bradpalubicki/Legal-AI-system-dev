name: ğŸ§ª Staging Deployment

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ main ]
    types: [ labeled ]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'develop'
      run_tests:
        description: 'Run integration tests'
        required: false
        default: true
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}
  STAGING_NAMESPACE: legal-ai-staging
  STAGING_DOMAIN: legal-ai-staging.example.com

jobs:
  # =============================================================================
  # STAGING ENVIRONMENT PREPARATION
  # =============================================================================
  prepare-staging:
    name: ğŸ—ï¸ Prepare Staging Environment
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/develop') ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'deploy-staging')) ||
      github.event_name == 'workflow_dispatch'

    outputs:
      should-deploy: ${{ steps.check-deploy.outputs.should-deploy }}
      image-tag: ${{ steps.set-image-tag.outputs.image-tag }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch || github.head_ref || github.ref }}

    - name: Check if deployment should proceed
      id: check-deploy
      run: |
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'deploy-staging') }}" == "true" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "should-deploy=true" >> $GITHUB_OUTPUT
        fi

    - name: Set image tag
      id: set-image-tag
      run: |
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "image-tag=pr-${{ github.event.pull_request.number }}-${{ github.sha }}" >> $GITHUB_OUTPUT
        else
          echo "image-tag=${{ github.sha }}" >> $GITHUB_OUTPUT
        fi

    - name: Clean up old PR deployments
      if: github.event_name == 'pull_request'
      run: |
        echo "ğŸ§¹ Cleaning up old PR deployments"
        # This would typically involve removing old PR-specific resources

  # =============================================================================
  # BUILD AND PUSH STAGING IMAGES
  # =============================================================================
  build-staging-images:
    name: ğŸ³ Build Staging Images
    runs-on: ubuntu-latest
    needs: [prepare-staging]
    if: needs.prepare-staging.outputs.should-deploy == 'true'
    
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        service: [backend, frontend, nginx, celery-worker]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch || github.head_ref || github.ref }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push staging image
      uses: docker/build-push-action@v5
      with:
        context: ${{ matrix.service == 'nginx' && './docker/nginx' || '.' }}
        file: ${{ matrix.service == 'nginx' && './docker/nginx/Dockerfile' || './docker/backend/Dockerfile' }}
        target: ${{ matrix.service == 'frontend' && 'development' || 'production' }}
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:staging-${{ needs.prepare-staging.outputs.image-tag }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:staging-latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          VCS_REF=${{ github.sha }}
          VERSION=staging-${{ needs.prepare-staging.outputs.image-tag }}

  # =============================================================================
  # DEPLOY TO STAGING KUBERNETES
  # =============================================================================
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [prepare-staging, build-staging-images]
    
    environment: 
      name: staging
      url: https://${{ env.STAGING_DOMAIN }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch || github.head_ref || github.ref }}

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: '1.28.0'

    - name: Set up Kustomize
      run: |
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        sudo mv kustomize /usr/local/bin/

    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBECONFIG_STAGING }}" | base64 -d > $HOME/.kube/config
        kubectl config current-context

    - name: Ensure staging namespace exists
      run: |
        kubectl create namespace ${{ env.STAGING_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

    - name: Update staging kustomization
      run: |
        cd kubernetes/overlays/staging
        
        # Update image tags for staging deployment
        IMAGE_TAG="staging-${{ needs.prepare-staging.outputs.image-tag }}"
        
        kustomize edit set image \
          legal-ai-backend=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:${IMAGE_TAG} \
          legal-ai-frontend=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:${IMAGE_TAG} \
          legal-ai-nginx=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-nginx:${IMAGE_TAG}

    - name: Deploy to staging
      run: |
        cd kubernetes/overlays/staging
        
        echo "ğŸš€ Deploying to staging environment..."
        
        # Apply staging deployment
        kubectl apply -k .
        
        # Wait for deployments to be ready
        kubectl rollout status deployment/backend -n ${{ env.STAGING_NAMESPACE }} --timeout=300s
        kubectl rollout status deployment/frontend -n ${{ env.STAGING_NAMESPACE }} --timeout=300s
        kubectl rollout status deployment/celery-worker -n ${{ env.STAGING_NAMESPACE }} --timeout=300s
        
        echo "âœ… Staging deployment completed"

    - name: Verify staging deployment
      run: |
        # Wait for pods to be ready
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=backend -n ${{ env.STAGING_NAMESPACE }} --timeout=180s
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=frontend -n ${{ env.STAGING_NAMESPACE }} --timeout=180s
        
        # Health checks
        for i in {1..20}; do
          if curl -f https://${{ env.STAGING_DOMAIN }}/health && curl -f https://${{ env.STAGING_DOMAIN }}/api/health; then
            echo "âœ… Staging health checks passed"
            break
          fi
          echo "â³ Waiting for staging to be healthy (attempt $i/20)"
          sleep 10
        done

  # =============================================================================
  # STAGING INTEGRATION TESTS
  # =============================================================================
  staging-tests:
    name: ğŸ§ª Staging Integration Tests
    runs-on: ubuntu-latest
    needs: [prepare-staging, deploy-staging]
    if: github.event.inputs.run_tests != 'false'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install test dependencies
      working-directory: ./frontend
      run: |
        npm ci
        npx playwright install --with-deps

    - name: Run integration tests against staging
      working-directory: ./frontend
      env:
        BASE_URL: https://${{ env.STAGING_DOMAIN }}
        TEST_USER_EMAIL: ${{ secrets.STAGING_TEST_USER_EMAIL }}
        TEST_USER_PASSWORD: ${{ secrets.STAGING_TEST_USER_PASSWORD }}
      run: |
        npm run test:e2e:staging

    - name: Run API tests
      run: |
        # Run API integration tests against staging
        curl -X POST https://${{ env.STAGING_DOMAIN }}/api/v1/test/integration \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.STAGING_API_TOKEN }}" \
          -d '{"suite": "full_integration"}'

    - name: Performance tests
      run: |
        # Basic performance testing with curl
        echo "ğŸš€ Running basic performance tests"
        
        for endpoint in "/health" "/api/health" "/api/v1/auth/health"; do
          echo "Testing ${endpoint}..."
          time curl -w "Time: %{time_total}s\nStatus: %{http_code}\n" \
            -s -o /dev/null \
            https://${{ env.STAGING_DOMAIN }}${endpoint}
        done

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: staging-test-results
        path: |
          frontend/test-results/
          frontend/playwright-report/

  # =============================================================================
  # STAGING FEEDBACK AND NOTIFICATIONS
  # =============================================================================
  staging-feedback:
    name: ğŸ“¢ Staging Feedback
    runs-on: ubuntu-latest
    needs: [prepare-staging, deploy-staging, staging-tests]
    if: always()

    steps:
    - name: Create PR comment for staging deployment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const deploymentSuccess = '${{ needs.deploy-staging.result }}' === 'success';
          const testsSuccess = '${{ needs.staging-tests.result }}' === 'success';
          
          const status = deploymentSuccess ? 'âœ…' : 'âŒ';
          const testStatus = testsSuccess ? 'âœ…' : 'âŒ';
          
          const comment = `## ğŸ§ª Staging Deployment ${status}
          
          **Environment**: [staging](https://${{ env.STAGING_DOMAIN }})
          **Commit**: \`${{ github.sha }}\`
          **Deployment**: ${deploymentSuccess ? 'Success' : 'Failed'}
          **Tests**: ${testsSuccess ? 'Passed' : 'Failed'}
          
          ### Quick Links
          - ğŸŒ [Staging App](https://${{ env.STAGING_DOMAIN }})
          - ğŸ”§ [API Health](https://${{ env.STAGING_DOMAIN }}/api/health)
          - ğŸ“Š [Grafana Dashboard](https://${{ env.STAGING_DOMAIN }}/grafana)
          - ğŸŒ¸ [Flower (Celery)](https://${{ env.STAGING_DOMAIN }}/flower)
          
          ### Test Results
          ${testsSuccess ? 'âœ… All integration tests passed' : 'âŒ Some tests failed - check workflow logs'}
          
          ---
          _Staging deployment will be automatically cleaned up after 7 days_`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Notify Slack about staging deployment
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#legal-ai-staging'
        text: |
          ğŸ§ª Staging deployment completed
          
          **Status**: ${{ needs.deploy-staging.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}
          **Branch**: ${{ github.head_ref || github.ref_name }}
          **Tests**: ${{ needs.staging-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
          **URL**: https://${{ env.STAGING_DOMAIN }}
          
          ${{ github.event_name == 'pull_request' && format('**PR**: #{0} - {1}', github.event.pull_request.number, github.event.pull_request.title) || '' }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # =============================================================================
  # AUTOMATIC CLEANUP
  # =============================================================================
  cleanup-old-deployments:
    name: ğŸ§¹ Cleanup Old Deployments
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'

    steps:
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: '1.28.0'

    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBECONFIG_STAGING }}" | base64 -d > $HOME/.kube/config

    - name: Clean up old PR deployments
      run: |
        echo "ğŸ§¹ Cleaning up deployments older than 7 days"
        
        # Get all PR deployments older than 7 days
        CUTOFF_DATE=$(date -d "7 days ago" +%Y-%m-%d)
        
        # This would involve cleaning up old PR-specific resources
        # kubectl delete deployment,service,ingress -l deployment-type=pr,created-before=${CUTOFF_DATE} -n ${{ env.STAGING_NAMESPACE }}
        
        echo "âœ… Cleanup completed"

    - name: Clean up old container images
      run: |
        echo "ğŸ—‘ï¸ Cleaning up old staging container images"
        # This would typically involve calling registry APIs to remove old images
        # Keep last 10 staging builds
        echo "Container image cleanup policy applied"