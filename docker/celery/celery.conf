# Celery Configuration for Legal AI System
# Optimized for legal document processing tasks

# Broker settings (Redis)
broker_url = 'redis://redis:6379/0'
result_backend = 'redis://redis:6379/1'

# Task serialization
task_serializer = 'json'
result_serializer = 'json'
accept_content = ['json']

# Timezone
timezone = 'UTC'
enable_utc = True

# Task routing
task_routes = {
    'tasks.document.*': {'queue': 'document_processing'},
    'tasks.ai.*': {'queue': 'ai_analysis'},
    'tasks.email.*': {'queue': 'email_processing'},
    'tasks.report.*': {'queue': 'report_generation'},
    'tasks.billing.*': {'queue': 'billing'},
    'tasks.backup.*': {'queue': 'maintenance'},
    'tasks.cleanup.*': {'queue': 'maintenance'},
}

# Task execution
task_always_eager = False
task_eager_propagates = True
task_ignore_result = False
task_store_eager_result = True

# Task time limits (increased for legal document processing)
task_soft_time_limit = 1800  # 30 minutes
task_time_limit = 3600       # 60 minutes
task_acks_late = True
worker_prefetch_multiplier = 1

# Result backend settings
result_expires = 3600  # 1 hour
result_compression = 'gzip'

# Connection settings
broker_connection_retry_on_startup = True
broker_connection_retry = True
broker_connection_max_retries = 10

# Worker settings
worker_max_tasks_per_child = 1000
worker_disable_rate_limits = False
worker_log_format = '[%(asctime)s: %(levelname)s/%(processName)s] %(message)s'
worker_task_log_format = '[%(asctime)s: %(levelname)s/%(processName)s][%(task_name)s(%(task_id)s)] %(message)s'

# Beat scheduler settings (for periodic tasks)
beat_schedule = {
    'cleanup-temp-files': {
        'task': 'tasks.cleanup.cleanup_temp_files',
        'schedule': 3600.0,  # Every hour
    },
    'generate-daily-reports': {
        'task': 'tasks.report.generate_daily_reports',
        'schedule': 86400.0,  # Daily at midnight
    },
    'backup-database': {
        'task': 'tasks.backup.backup_database',
        'schedule': 21600.0,  # Every 6 hours
    },
    'process-pending-documents': {
        'task': 'tasks.document.process_pending_documents',
        'schedule': 300.0,    # Every 5 minutes
    },
    'check-contract-expiry': {
        'task': 'tasks.contract.check_contract_expiry',
        'schedule': 86400.0,  # Daily
    },
    'generate-compliance-reports': {
        'task': 'tasks.compliance.generate_compliance_reports',
        'schedule': 604800.0, # Weekly
    },
}

# Security settings
worker_hijack_root_logger = False
worker_log_color = False

# Optimization settings for legal document processing
worker_pool_restarts = True

# Task annotations for monitoring
task_annotations = {
    '*': {
        'rate_limit': '100/h',
        'time_limit': 3600,
        'soft_time_limit': 1800,
    },
    'tasks.ai.*': {
        'rate_limit': '10/m',  # AI tasks are more resource intensive
        'time_limit': 7200,    # 2 hours for complex AI analysis
        'soft_time_limit': 3600,
    },
    'tasks.document.ocr_processing': {
        'rate_limit': '5/m',   # OCR is CPU intensive
        'time_limit': 1800,
        'soft_time_limit': 900,
    },
    'tasks.email.*': {
        'rate_limit': '50/m',  # Email tasks can be more frequent
    },
}

# Error handling
task_reject_on_worker_lost = True
task_acks_on_failure_or_timeout = True

# Monitoring
worker_send_task_events = True
task_send_sent_event = True

# Queue priorities
task_inherit_parent_priority = True
task_default_priority = 5
task_queue_max_priority = 10

# Memory and performance
worker_max_memory_per_child = 200000  # 200MB
worker_autoscaler = 'celery.worker.autoscale:Autoscaler'